.deploy-trigger:
  script:
    - echo "triggering deploy of ${CI_ENVIRONMENT_SLUG}"
    - |
      curl --request POST \
        --form "token=$CI_JOB_TOKEN" \
        --form "ref=deploy" \
        --form "variables[DEPLOY_ENV]=$DEPLOY_ENV" \
        --form "variables[DEPLOY_COMMIT_REF_NAME]=$CI_COMMIT_REF_NAME" \
        --form "variables[DEPLOY_STOP]=$DEPLOY_STOP" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/trigger/pipeline"

.stop-trigger:
  script:
    - echo "triggering stop of ${CI_ENVIRONMENT_SLUG}"

deploy-test-trigger:
  extends: .deploy-trigger
  variables:
    DEPLOY_ENV: test
  environment:
    name: test
    on_stop: stop-test-trigger
  when:
    manual

stop-test-trigger:
  extends: .stop-trigger
  variables:
    DEPLOY_ENV: test
    DEPLOY_STOP: "1"
  environment:
    name: test
    action: stop
  when:
    manual

deploy-review-trigger:
  extends: .deploy-trigger
  variables:
    DEPLOY_ENV: review
  environment:
    name: review/${DEPLOY_COMMIT_REF_NAME}
    on_stop: stop-review-trigger
  when:
    manual

stop-review-trigger:
  extends: .stop-trigger
  variables:
    DEPLOY_ENV: review
    DEPLOY_STOP: "1"
  environment:
    name: review/${DEPLOY_COMMIT_REF_NAME}
    action: stop
  when:
    manual
